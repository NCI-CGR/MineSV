#!/usr/bin/env python3

import os

# snakemake -s modules/Snakefile_delly_somatic --cluster "qsub -o /DCEG/CGF/Bioinformatics/Production/Bari/Struct_var_pipeline_dev/snake_tests/ -j y -pe by_node 2" --jobs 100 --latency-wait 300

dellyWkngDir = parentDir + 'delly_TN/'

TYPES = ['DEL', 'DUP', 'INV', 'BND', 'INS']

rule delly_softlink_ref_seq:
    input:
        ref
    output:
        dellyWkngDir + 'refGenome/' + refFile
    shell:
        'ln -s {input} {output}'

rule delly_call:
    input:
        t = get_tumor_bam,
        tIndex = get_tumor_index,
        n = get_normal_bam,
        nIndex = get_normal_index,
        ref = dellyWkngDir + 'refGenome/' + refFile
    params:
        tp = '{type}',
        path = execDir + 'sv_callers/'
    output:
        dellyWkngDir + 'calls/{sample}_{type}.bcf'
    shell:
        '/DCEG/CGF/Bioinformatics/Production/Bari/Struct_var_pipeline_dev/pipeline/sv_callers/delly_v0.7.7_parallel_linux_x86_64bit call \
            -t {params.tp} \
            -o {output} \
            -g {input.ref} \
            {input.n} {input.t}'
            #-x /DCEG/CGF/Bioinformatics/Production/Bari/Struct_var_pipeline_dev/sv_callers/delly/excludeTemplates/human.hg19.excl.tsv \
            # exclude file?
            # or, wildcards.type instead of params

rule delly_create_tsv:
    input:
        t = get_tumor_bam,
        tIndex = get_tumor_index,
        n = get_normal_bam,
        nIndex = get_normal_index
    output:
        dellyWkngDir + 'somatic/{sample}_samples.tsv'
    params:
        path = execDir + 'scripts/'
    shell:
        'module load samtools;'
        '{params.path}create_tsv.sh {input.t} tumor {output};'
        '{params.path}create_tsv.sh {input.n} control {output}'
    # tab-delimited sample description file where the first column is the sample id (as in the VCF/BCF file) and the second column is either tumor or control

rule delly_pre_filter:
    input:
        bcf = dellyWkngDir + 'calls/{sample}_{type}.bcf',
        tsv = dellyWkngDir + 'somatic/{sample}_samples.tsv'
    output:
        dellyWkngDir + 'somatic/{sample}_{type}.bcf'
    params:
        tp = '{type}',
        path = execDir + 'sv_callers/'
    shell:
        '/DCEG/CGF/Bioinformatics/Production/Bari/Struct_var_pipeline_dev/pipeline/sv_callers/delly_v0.7.7_parallel_linux_x86_64bit filter \
            -t {params.tp} \
            -f somatic \
            -o {output} \
            -s {input.tsv} \
            {input.bcf}'
            # tab-delimited sample description file where the first column is the sample id (as in the VCF/BCF file) and the second column is either tumor or control

rule delly_combine_output:
    input:
        expand(dellyWkngDir + 'somatic/{{sample}}_{type}.bcf', type=TYPES)
    output:
        dellyWkngDir + 'somatic/{sample}_all.txt'
    shell:
        'module load bcftools;'
        'bcftools concat -a {input} | sort -k1,1 -k2,2n > {output}'

rule delly_list_output_files:
    input:
        dellyWkngDir + 'somatic/{sample}_all.txt'
    output:
        temp(parentDir + 'SV_files_for_annotation_delly.{sample}.txt')
    params:
        path = execDir + 'scripts/'
    shell:
        '{params.path}list_files.sh {input} {wildcards.sample} > {output}'

rule delly_merge_list:
    input:
        expand(parentDir + 'SV_files_for_annotation_delly.{sample}.txt', sample=bamDict.keys())
    output:
        parentDir + 'SV_files_for_annotation_delly.txt'
    shell:
        'cat {input} | sort | sed "1s/^/sample delly\\n/" > {output}'


# rule delly_re_genotype:
#     input:
#     output:
#     shell:
#         'delly call -t DEL -g hg19.fa -v t1.pre.bcf -o geno.bcf -x hg19.excl tumor1.bam control1.bam ... controlN.bam'

# rule delly_post_filter:
#     input:
#     output:
#     shell:
#         'delly filter -t DEL -f somatic -o t1.somatic.bcf -s samples.tsv geno.bcf'